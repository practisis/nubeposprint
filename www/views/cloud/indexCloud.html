
<script>
		var loopSicnronizador;
		var empresa = localStorage.getItem('empresa');
	
		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
			tx.executeSql('SELECT nombreempresa FROM empresa',[],function(tx,results){
				
								for (var i=0; i <= results.rows.length-1; i++){
									var row = results.rows.item(i);
									var nombreempresa = row.nombreempresa;
								}
									if(nombreempresa){
										$(".putEmp").html(""+nombreempresa+ "<small>("+empresa+")</small>");
										$("#yaConectado").fadeIn();
										$("#contentLogin").css("display" , "none");
										$("#texto15Dias").css("display" , "none");
										$("#demoGratis").css("display" , "none");
										$("#fadeRow").css("display" , "none");
										clearInterval(loopSicnronizador);
										loopSicnronizador=setTimeout(function(){
											
											recibeConsultaApi(empresa,nombreempresa)
										},15000);
									}else{

										nuevaCuenta();
									}	

			},errorCB ,successCB);
		});

		
			/*setInterval(function(){
				y=Math.floor((Math.random() * 100) + 1);
				$('#progress2 div').width(y + "%");
			},2000);*/
		
</script>
	<div class="row">
		<div class="col-xs-12">
			<div id="yaConectado" style="display:none;width:100%;padding:0px;margin:0px;">
				<div class="modal-header" style="background-image: url(http://www.practipos.com/img/parallax-bg.jpg);padding-top: 35px;
					padding-bottom: 35px;
					color: #fff;
					border-radius: 4px 4px 0 0;
					background-position: center top;font-size: 40px;    padding: 15px;
					border-bottom: 1px solid #e5e5e5;
					min-height: 16.42857143px;">
			  		NubePOS Conectado <br/> <label class="putEmp"></label>
			  		<small><br/>Sincronizando...</small>
			  		<center><a href="https://www.practisis.net/login.php" target="_blank" ><input class="btn btn-md btn-primary btn-center" type="button"  value="Abrir punto de venta en la nube" /> </a></center>
			</div>
			
			</div>
		</div>
	</div>

<div class="row" id="contentStepSincro" style="display:none;" >
		<div class="col-md-3" ></div>
		<div class="col-md-6" >
			
				<div class="bs-example" data-example-id="simple-nav-justified">
				<ul class="nav nav-tabs nav-justified">
				  <li role="presentation" class="active"><a href="#"> <span class="badge">1</span> Productos</a></li>
				  <li role="presentation"><a href="#"> <span class="badge">2</span> Facturas</a></li>
				  <li role="presentation"><a href="#"> <span class="badge">3</span>  Clientes</a></li>
				  <li role="presentation"><a href="#" >  <span class="badge">4</span> Final </a></li>
				</ul>
				<br><br>
				<center> <i> <span id="txtSincro">Sincronizando Productos...</span> </i> </center>
				<div class="progress" >
					<div id="theProgress" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width: 0.5%"><span class="sr-only">25% Complete</span></div>
				</div>
			  </div>
			  
			
			
		</div>
		<div class="col-md-3" ></div>
	</div>

	<div id="putHereIframes" style="display:none;"> </div>
	<div class="row" style="display:block;" id="fadeRow" >
		<div class="col-md-3" >
		</div>
		<div class="col-md-6">
		<div class="modal-content text-center" id="contentLogin" style="min-height: 263px;">
			<div class="modal-header" style="background-image: url(http://www.practipos.com/img/parallax-bg.jpg);padding-top: 35px;
		padding-bottom: 35px;
		color: #fff;
		border-radius: 4px 4px 0 0;
		background-position: center top;font-size: 40px;    padding: 15px;
		border-bottom: 1px solid #e5e5e5;
		min-height: 16.42857143px;">
			  NubePOS
			</div>
			<div class="modal-body" style="min-height: 266px;">
			 <div id="divdatoslogin" style="overflow:auto;">
			  <h3 style="-webkit-margin-before: 1em;
		-webkit-margin-after: 1em;
		-webkit-margin-start: 0px;
		-webkit-margin-end: 0px;">Ingresa a tu sistema y <span style="color:#0893d2;">Empecemos!</span></h3>
			  <span class="subtitle" style=" margin-bottom: 36px; margin-top: 0;font-size:16px;color:#9a9a9a;">Ingresa tus datos</span><br><br>
			 
			  <form method="post" class="contact-form form-validate4" id="myloginform" novalidate="novalidate">
				<div class="form-group">
				  <input class="form-control input-lg" type="text" id="user2" name="usuario" placeholder="Usuario" required="" value="josue@misocioweb.com" autocomplete="off" aria-required="true">
				</div>
				<div class="form-group">
				  <input type="password" id="pass2" name="mipass" value="123456" class="form-control input-lg" placeholder="Password" required="" autocomplete="off" aria-required="true">
				</div>
				<div class="form-group">
					<a data-toggle="modal" data-target="#recuperarPass" href="">¿Olvidaste tu contraseña?</a><br/>  <a data-toggle="modal" data-target="#recuperarPass" href="javascript:void(0);" ontap="nuevaCuenta()">¿Crear Cuenta NubePOS?</a> 
				</div>
			   <button class="btn btn-primary"  id="btnvalida2" type="button" ontap="loginPractisis();">Login</button>
			  </form>
			  </div>
			  
			  <div id="varias">
			  </div>
			</div>
		  </div>
		</div>
		
		<div class="col-md-3" >
		<div id="mensaje2"></div>
		<input id="user" type="hidden" />
		<input id="pass" type="hidden" />
		</div>
		<br><br><br><br><br><br><br><br><br>
	  </div> <!--End row -->

	  <script>
	  	
			function mostrarSignIn(){
				$(".putHeightRows").css("height" , $(window).height() + "px");
				$("#demoGratis").css("display" , "none");
				$("#fadeRow").fadeIn();
			
			}
			
			function nuevaCuenta(){
				$(".putHeightRows").css("height" , $(window).height() + "px");
				$("#fadeRow").css("display" , "none");
				$("#demoGratis").fadeIn("fast",function(){
					$("#animaRegister").animate({ top : "50px" });
				});
			}
	  </script>
	  <!-- Registro -->
	  <div class="row" style="display:none;" id="demoGratis" >
		<div class="col-md-3" >
		</div>
		
		<div class="col-md-6" class="putHeightRows" style="position:relative;min-height: 800px;overflow:hidden;">
			<label id="texto15Dias">Puedes conectarte a una cuenta NubePOS <br/> para ver tus datos en la nube y manejar invetarios</label>
			<div class="modal-content text-center" id="animaRegister" style="min-height: 263px;width:100%;position:absolute;left:0px;top:-1200px;">
				<div class="modal-header" style="background-image: url(http://www.practipos.com/img/parallax-bg.jpg);padding-top: 35px;
					padding-bottom: 35px;
					color: #fff;
					border-radius: 4px 4px 0 0;
					background-position: center top;font-size: 40px;    padding: 15px;
					border-bottom: 1px solid #e5e5e5;
					min-height: 16.42857143px;">
				  NubePOS
				</div>
			<div class="modal-body" style="min-height: 266px;">
			 <div id="divdatoslogin" style="overflow:auto;">
			  <h3 style="-webkit-margin-before: 1em;
		-webkit-margin-after: 1em;
		-webkit-margin-start: 0px;
		-webkit-margin-end: 0px;">Solicita tu NubePOS  </h3>
			 <!-- <span class="subtitle" style=" margin-bottom: 36px; margin-top: 0;font-size:16px;color:#9a9a9a;">No necesitas tarjeta de crédito</span><br><br>-->
			 
			 <!--  <div class="form-group">
              <input class="form-control input-lg" type="text" name="nombres" id="nombres" placeholder="Tu nombre completo" required="" autocomplete="off">
            </div>-->
            <div class="form-group">
              <input type="form-control input-lg" name="empresa"  class="form-control input-lg" id="newEmpresa" placeholder="Nombre de tu Negocio" required="" autocomplete="off">
            </div>

            <div class="form-group">
              <input class="form-control input-lg" type="email" name="email" id="newEmail" placeholder="E-mail" required="" autocomplete="off">
            </div>

           

<!--
            <div class="form-group">
              <input type="text" name="telefono" id="telefono" class="form-control input-lg" placeholder="Teléfono" required="" autocomplete="off">
            </div>
        -->
         <div class="form-group">
              <input type="password" name="pass" id="newPass"  class="form-control input-lg" placeholder="Ingresa una contraseña" required="" autocomplete="off">
            </div>
			 <div class="form-group">
              <input type="password" name="pass" id="newConfirm"  class="form-control input-lg" placeholder="Confirma tu contraseña" required="" autocomplete="off">
            </div>
			<!--
			<div class="form-group">
              <input type="form-control input-lg" name="empresa" id="empresa" class="form-control input-lg" placeholder="Nombre de tu Negocio" required="" autocomplete="off">
            </div>
        -->

           <!-- <div class="form-group">
              <textarea style="height: 80px;" id="observacion" name="observacion" class="form-control input-lg" placeholder="Observaciones" required="" autocomplete="off"></textarea>
            </div>
        -->
			
			
			<div class="form-group">
					<a data-toggle="modal" data-target="#recuperarPass" onclick="mostrarSignIn();" href="">¿Ya tienes cuenta NubePOS?</a><br/> 
			</div>
				
			
<input class="btn btn-md btn-primary btn-center" type="button" id="btnNewEmp" value="Enviar" onclick="registrarUser();">
			  </div>
			  
			  <div id="varias">
			  </div>
			</div>
		  </div>
		</div>
		
		<div class="col-md-3" >
		<div id="mensaje2"></div>
		<input id="user" type="hidden" />
		<input id="pass" type="hidden" />
		</div>
		
	  </div> <!--End row -->
	  <br/><br/><br/><br/><br/><br/><br/><br/>
	  <!-- STEP 1 -->
	  <div id="JSONproductosLocal" style="color:red;display:none;"></div>
	  <div id="JSONproductosNube"  style="color:blue;display:none;" ></div>
	  <div id="JSONCategoriasLocal"  style="color:green;display:none;"></div>
	  <div id="JSONCategoriasNube"  style="color:gray;display:none;"></div>
	  <!-- STEP 2 --->
		<div id="JSONfacturas" style="color:red;display:none;"></div>
	  <!-- STEP 2 --->
	  <div id="JSONclientesNube" style="color:red;display:none;"></div>
	  <div id="JSONclientesLocal" style="color:red;display:none;" ></div>
	  
	  
	  
	  <!--
	<div  style="display:none;background: rgba(0,0,0 0.8) none repeat scroll 0% 0%; width: 60%; height: auto; position:; z-index: 20000; text-align: center;margin:0 auto;margin-top:30px;" id='cuentasSinc'>
		<div class='row' id='popupLogin2' style="padding-top:6%; box-shadow: 0px 0px 5px 0px rgba(50, 50, 50, 0.75); background-color: #ffffff; color: #000000; margin-left: auto; margin-right: auto;overflow:auto;height:130px;border:10px solid #2EC1CC;">
			<div class='col-md-5'>
				<button type="button" class="btn btn-primary" onclick='nuevaCuenta()'>Crear Nueva Cuenta NubePOS</button>
			</div>
			<div class='col-md-2'></div>
			<div class='col-md-5'>
				<button type="button" class="btn btn-primary" onclick='usarLogin()'>Usar Cuenta Existente NubePOS</button>
			</div>
		</div>
	</div>
-->
	<!--
	<div id="popupLoginNuevo" style="display:none;width:50%;padding:20px;margin-top: 10px; box-shadow: 0px 0px 5px 0px rgba(50, 50, 50, 0.75); background-color: #ffffff; color: #000000; margin-left: auto; margin-right: auto;overflow:auto;height:350px;">

	 
	

		<div class="encabezadorojo" style='position:relative;height:30px;font-size:20px;padding-left:10px;'>

		LOGIN PRACTISIS<img src='images/xcierre.png' style='position:absolute; top:3px; right:5px; cursor:pointer;' onclick='cerrarLogin2()'/></div>
		<div style='background-color:#E0DEDE; padding-top:20px; padding-bottom:20px;' id='contieneEmpresasNuevo'>
			<div class="row" style="padding-top: 10px;padding-bottom: 10px;">
				<div class="col-md-12"  style="text-align: center;">
						<div class="panel panel-default">
								<div  class="panel-heading">
									<strong><span class="glyphicon glyphicon-th"></span>
									 Autentificación de Usuario
								</div>        
								<div class="panel-body">
									<div class="input-group">
										<label class="input-group-addon">User:</label>
										<input type="text" id="user2" class="form-control" />
									</div>
									<div style="height:10px;"></div>
									<div class="input-group">
										<label class="input-group-addon">Pass:</label>
										<input type="password" id="pass2" class="form-control" />
									</div>
									<div style="height:10px;"></div>
									<button class="btn btn-default" id='btnvalida2' type="button" onclick="valida2();">Login</button>
								</div>
						</div>
								<div id="mensaje2"></div>
					</div>
			</div>
		</div>
	</div>
	-->
	<!--
	<div id="contenedorNuevaCuenta" style='display:none;margin-top:50px;'>
		<img src='images/xcierre.png' style='position:absolute; top:3px; right:5px; cursor:pointer;' onclick='cerrarLogin3()'/>
		<iframe src='http://practisis.net/registro/registrate.php' width='100%' height='800px' frameborder='no' ></iframe>
	</div>
	<div id='recibeAlertasActualizaciones'></div>
	<div id="mainDivSinc" style="margin: 0px; padding: 0px; width:100%; height: 800px; background-color: #ffffff; font-size:14px; color:#404041;display:none;">
		<table style="width:100%;" border="0" cellpadding='10px' class='table table-striped' style='display:none;'>
			<tr>
				<td >
					<h3>Lista de Productos</h3>
				</td>
				<td>
					<div>
						<i class="fa fa-cloud-upload fa-5x" onclick='subeDatos()' id='sube1'></i>
							<h1 onclick='subeDatos()' >Sube1.1</h1>
						<i class="fa fa-cloud-upload fa-5x" id='sube2' style='display:;' onclick='subeFacturas()'></i>
					</div>
				</td>
				<td>
					<div style='display:none;'>
						<i class="fa fa-download fa-5x" onclick='subeClientes()' id='sube1'></i>
						<h1>Sube1.2</h1>
					</div>
				</td>
			</tr>
			<tr>
				<td style="text-align: right; vertical-align:middle; width: 450px;">-->
					<!--<select id="categoryType" class='selectpicker'>
						<option value="0">Todas las categorías</option>
					</select>-->
					<!-- Single button -->
					<!--
					<select id='listacategorias' style='font-size:15px;'>
						<option value='0'>Todas las categorias</option>
					</select>
				</td>
				<td style="text-align: left; vertical-align:middle; width: 550px;">
					<table style="margin-left: 0px; margin-right: auto;" border="0" cellpadding="4px" cellspacing="10px">
						<tr>
							<td style='vertical-align:middle;'>
								<input placeholder='busqueda' type="text" class='form-control' id="searchKeyword" name="category"/>
							</td>
							<td  style='vertical-align:middle;'>
								<button type='button' class="btn btn-primary" onclick="page=0; getSearch(); return false;">Buscar</button>-->
								<!--<input type="image" style="padding: 0px; margin: 0px;" onclick="getSearch(); return false;" alt="Search" src="gfx/search.png"/>-->
								<!--
							</td>
						</tr>
					</table>
				</td>
				<td></td>
			</tr>
			<tr>
				<td colspan="3">
					<div id="detailDiv2" style="height:650px; padding-top:20px; margin:0px; font-size:15px;display:none;"></div>
				</td>
			</tr>
			<tr>
				<td colspan="3" style='text-align:center;'>
					<ul class="pagination paginacion-lg" id='paginacion' style='display:none;'>
					</ul>
					<input id='totalpags' style='display:none;'/>
				</td>
			</tr>
		</table>	
	</div>
	-->
	<input type="hidden" id="idcategoria" />
	
	<script type="text/javascript">
	
	/*----------- 
		Process:
		    0.1.sincronizarProcess();
			0.2 obtenerDatosNube();
		1.1  compararJSONproductos();
		1.2	sincronizacionCategorias();
	------------>
	*/
	<!-- ---------(Step 1.1 )Sincronizacion Productos ---------- -->
		function compararJSONproductos(){
			JSONproductosLocal=$("#JSONproductosLocal").html();
			JSONproductosNube=$("#JSONproductosNube").html();
			console.log('________');
			console.log(JSONproductosLocal);
			console.log('________');
			console.log(JSONproductosNube);
			JLocal=jQuery.parseJSON(JSONproductosLocal);
			JNube=$.parseJSON(JSONproductosNube);
			arrayProductosLocalFaltantes= new Array();
			contTsNube=-1;
			
			for(j=0; j<= (JLocal.Productos.length -1); j++ ){
				hayProductoEnNube=false;
				pLocal=JLocal.Productos[j];		
				tsLocal=$.trim(pLocal.timespan);
				formuladoLocal=pLocal.formulado;
				for(k=0; k<= (JNube.Productos.length -1); k++ ){
						pNube=JNube.Productos[k];		
						tsNube=$.trim(pNube.formulado_timespan);
						if(tsLocal==tsNube) { 
						hayProductoEnNube=true; }
				}

				if(hayProductoEnNube==false){
					//alert("No hay producto local en nube");
					arrayProductosLocalFaltantes[arrayProductosLocalFaltantes.length]=tsLocal;
					//alert("No hay producto local en nube" + formuladoLocal);
				}
			}
			//alert("here");
			sincronizaFaltanteProductosLocal();
			
		}
		
		
		
		
		var globalContProductosLocal=-1;
		function sincronizaFaltanteProductosLocal(){
			//alert(arrayProductosLocalFaltantes.length-1);
			//alert(globalContProductosLocal+ "<>" + (arrayProductosLocalFaltantes.length-1)  );
			if( (globalContProductosLocal + 1) > (arrayProductosLocalFaltantes.length-1 ) ){
				console.log("fin bucle");//fin Sincronizacion Local
				$("#theProgress").css("width" , "12.5%");
				sincronizaFaltanteProductosNube();
				return ;
			}else{
				globalContProductosLocal++;
				actualTimeSpan=arrayProductosLocalFaltantes[globalContProductosLocal];
				//Actualizar Productos faltantes Locales en la Nube 
				//alert( arrayProductosLocalFaltantes[globalContProductosLocal]  );
				
				JSONproductosLocal=$("#JSONproductosLocal").html();
				JLocal=jQuery.parseJSON(JSONproductosLocal);
				var formulado="";
				for(j=0; j<= (JLocal.Productos.length -1); j++ ){
					pLocal=JLocal.Productos[j];		
					if(pLocal.timespan==actualTimeSpan){
						formulado= pLocal.formulado;
						codigo= pLocal.codigo;
						categoriaid= pLocal.categoriaid;
						categorianombre= pLocal.categorianombre;
						precio= pLocal.precio;
						cargaiva= pLocal.cargaiva;
						productofinal= pLocal.productofinal;
						materiaprima= pLocal.materiaprima;
						
					}
				}
				
				if(formulado){
					//alert(formulado + "<<" +empresa);
						$.post('http://practisis.net/practipos2/ajax/apiSincronizador/apiSincronizaNubeposProductosNew.php',{
							empresa : empresa , formulado : formulado , codigo : codigo , precio : precio , categorianombre : categorianombre , cargaiva : cargaiva , productofinal : productofinal , materiaprima : materiaprima, timespan : actualTimeSpan
						}).done(function(data){
							$("#theProgress").css("width" , "12.5%");
							//globalContProductosLocal //globalContProductosLocal 
							prc=( 12.5 / arrayProductosLocalFaltantes.length ) * globalContProductosLocal ;
							$("#theProgress").css("width" , prc + "%");
							
							//alert(data);
							console.log(data);
						});
					
				}
				
				sincronizaFaltanteProductosLocal();
			}
			
		}
		
		var arrayProductosNubeFaltantes;
		
		function sincronizaFaltanteProductosNube(){
			//alert("Start Nube");
			
			JSONproductosLocal=$("#JSONproductosLocal").html();
			JSONproductosNube=$("#JSONproductosNube").html();
			JLocal=jQuery.parseJSON(JSONproductosLocal);
			JNube=$.parseJSON(JSONproductosNube);
			arrayProductosNubeFaltantes= new Array();
			contTsNube=-1;
			
			for(j=0; j<= (JNube.Productos.length -1); j++ ){
				hayProductoEnNube=false;
				pNube=JNube.Productos[j];		
				tsNube=$.trim(pNube.formulado_timespan);
				formuladoNube=pNube.formulado_nombre;
				formuladoNubeID=pNube.formulado_id;
				//alert(formuladoNube);
				for(k=0; k<= (JLocal.Productos.length -1); k++ ){
						pLocal=JLocal.Productos[k];		
						tsLocal=$.trim(pLocal.timespan);
						if(tsLocal==tsNube) { 
							//alert("Producto Coincide" + formuladoNube);
							hayProductoEnNube=true;
	
						}
				}
				if(hayProductoEnNube==false){
					arrayProductosNubeFaltantes[arrayProductosNubeFaltantes.length]=formuladoNubeID;
					//alert(formuladoNubeID);
				}
			}
			
			sincronizaProductoNube();
			
		}
		
		var globalContProductosNube=-1;
		var globalTSNube="";
		function sincronizaProductoNube(){
				if(!arrayProductosNubeFaltantes.length) {
					$("#theProgress").css("width" , "25%");
					sincronizacionCategorias();
					return;
				}
			if( (globalContProductosNube + 1) > (arrayProductosNubeFaltantes.length-1 ) ){
				console.log("fin bucle Nube Productos");//fin Sincronizacion Local
				$("#theProgress").css("width" , "25%");
				//alert("Step 1.2");
				sincronizacionCategorias();
				
				return ;
			}else{
				globalContProductosNube++;		
				currentFormulado=arrayProductosNubeFaltantes[globalContProductosNube];
				JSONproductosNube=$("#JSONproductosNube").html();
				JNube=jQuery.parseJSON(JSONproductosNube);
				var formulado="";
				timeSpan="";
				for(j=0; j<= (JNube.Productos.length -1); j++ ){
					pNube=JNube.Productos[j];		
					if(pNube.formulado_id==currentFormulado){
						formulado= pNube.formulado_nombre;
						codigo= pNube.formulado_codigo;
						precio= pNube.formulado_precio;
						impuesto = pNube.formulado_impuesto;
						tipo= pNube.formulado_tipo;
						categoriaid= pNube.categoria_id;
						categorianombre= pNube.categoria_nombre;
						cargaiva= pNube.cargaiva;
						productofinal= pNube.formulado_productofinal;
						materiaprima= pNube.formulado_matprima;
						timeSpan=  pNube.formulado_timespan;
						formulado_id=pNube.formulado_id;
						//alert(formulado + "<>" + timeSpan);
						
					}
				}
				
				if(formulado){
					actualTimeSpan=timeSpan;
					globalTSNube=timeSpan;
					if(actualTimeSpan=="0"){
						actualTimeSpan=getTimeSpan();
						globalTSNube= actualTimeSpan ;
						}
					//alert(formulado + "<<" + globalTSNube);
						$.post('http://practisis.net/practipos2/ajax/apiSincronizador/apiSincronizaNubeposProductosNew.php',{ tipo : "actualizar" ,
							formulado_id : formulado_id , empresa : empresa , formulado : formulado , codigo : codigo , precio : precio , categorianombre : categorianombre , cargaiva : cargaiva , productofinal : productofinal , materiaprima : materiaprima, timespan : globalTSNube
						}).done(function(data){
						
							prc=( 12.5 / arrayProductosNubeFaltantes.length ) * (globalContProductosNube +1) ;
							$("#theProgress").css("width" , (12.5 + prc )+ "%");
							
							// 1. Validar Si existe  Categoria
							//2. Meter Categoria si no existe
							categoria=categorianombre;
							//alert(formulado + "<<" + globalTSNube);
							var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
								db.transaction(function(tx){
								timeSpanCat=getTimeSpan();
								tx.executeSql('INSERT INTO CATEGORIAS(categoria,activo,existe , timespan ) SELECT "'+categoria+'",1,0,'+categoriaid+' WHERE NOT EXISTS(SELECT 1 FROM CATEGORIAS WHERE categoria = "'+categoria+'");',[],function(tx,results){
								
									$('#idcategoria').val(results.insertId);
									console.log("categ:"+results.insertId);
									//alert(localCategoriaID(categoriaid));
									//idcategoria=results.insertId;//$('#idcategoria').val();
									 idcategoria=localCategoriaID(categoriaid);//categoriaid;
									//if(!idcategoria)
									if( !cargaiva )  cargaiva = '0';
									if( !productofinal )  productofinal = '0';
									if( !materiaprima )  materiaprima = '0';
									
									
									db.transaction(function(tx){
										tx.executeSql('INSERT INTO PRODUCTOS(id,formulado,codigo,precio,categoriaid,cargaiva,productofinal,materiaprima,timespan) SELECT 0,"'+formulado+'","'+codigo+'","'+precio+'",'+idcategoria+','+cargaiva+','+productofinal+','+materiaprima+','+globalTSNube+' WHERE NOT EXISTS(SELECT 1 FROM PRODUCTOS WHERE formulado like "'+formulado+'" or codigo like "'+codigo+'");',[],function(tx,results){
										console.log("prod:"+results.insertId);
											sincronizaProductoNube();
											//  alert("InsertadoProdoucto>>" + formulado );
										});
									},errorCB,successCB);
								});
								},errorCB,successCB);
							
							
							
							console.log(data);
							
						});
					
				}
				
				
			}
		
		}
		
		
		/* ------------ FIN (STEP 1.1) Sincronizacion Productos ---------- */
		
		
		
		/* ------------ (STEP 1.2) Sincronizacion Categorias ---------- */
		function localCategoriaID(categoriaid){
			
			
			JSONCategoriasLocal=$("#JSONCategoriasLocal").text();
			//alert(JSONCategoriasLocal);
			JLocalCat=$.parseJSON(JSONCategoriasLocal);
			hayMatch=false;
			for(i=0;i<=(JLocalCat.Categorias.length-1); i++){
				id=JLocalCat.Categorias[i].id;
				timespan=JLocalCat.Categorias[i].timespan;
				if(categoriaid == timespan){
					hayMatch=true;
					return id;
					
				}
			}
			if(hayMatch==false){
			return categoriaid;
			}
			/*
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
				tx.executeSql('SELECT id FROM CATEGORIAS WHERE timespan=?',[categoriaid],function(tx,results){
				
				var row = results.rows.item(0);
				return row.id;
				},errorCB ,successCB);
				});*/
			//categoriaid
		}
		
		function sincronizacionCategorias(){
			
			
			
			$.post('https://www.practisis.net/nubeposboot/www/ajax/dataserviceNew.php',{
								id_emp : empresa 
						}).done(function(response){
					//alert(response);
					var arraydatos=JSON.parse(response); 
					JSONproductosNube=arraydatos.productos;
					JSONcategoriasNube=arraydatos.categorias;
					$("#JSONCategoriasNube").html(JSONcategoriasNube);
					$("#JSONproductosNube").html(JSONproductosNube);
					//$("#JSONproductosLocal").html('');
						cargarJSONLocalCategorias();
						
					});
			
		}
		function cargarJSONLocalCategorias(){
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
			tx.executeSql('SELECT * FROM CATEGORIAS',[],function(tx,results){
					$("#JSONCategoriasLocal").html(' { "Categorias" :  [ ');
					txt='';
								for (var i=0; i <= results.rows.length-1; i++){
									var row = results.rows.item(i);
									var idCat = row.id;
									var timeSpan = row.timespan;
									var categoria = row.categoria;
									var activo = row.activo;
									var existe = row.existe;
									txt+='{  "id" : "'+idCat+'" ,  "categoria" : "'+categoria+'" ,  "activo" : "'+activo+'" ,  "existe" : "'+existe+'" ,  "timespan" : "'+timeSpan+'"  },';
									//$("#JSONCategoriasLocal").append(txt);
								}
								txt=txt.substring(0,txt.length-1);
								$("#JSONCategoriasLocal").append(txt+" ]}");
								validarJsonCategorias();
			},errorCB ,successCB);
		});
						
			
		}
		var arrayFaltanteCategoryLocal=new Array();
		function validarJsonCategorias(){
			JSONCategoriasNube= $("#JSONCategoriasNube").text();
			JSONCategoriasLocal=  $("#JSONCategoriasLocal").text();
			JCNube=jQuery.parseJSON(JSONCategoriasNube);
			JCLocal=jQuery.parseJSON(JSONCategoriasLocal);
			for(i=0;i<=(JCLocal.Categorias.length-1);i++){
				catLocal=JCLocal.Categorias[i];
				timeSpan=catLocal.timespan;
				idCatLocal=catLocal.id;
				categoriaLocal=$.trim(catLocal.categoria).toLowerCase();
				var hayMatchCat=false;
				var hayMatchNombre=false;
				for(j=0; j<=JCNube.Categorias.length-1; j++){
					catNube=JCNube.Categorias[j];
					idNube=catNube.categoria_id;
					categoriaNube=$.trim(catNube.categoria_nombre).toLowerCase();
					if(timeSpan==idNube){
						hayMatchCat=true;
					}
					
					
					
					if(categoriaNube==categoriaLocal){
						hayMatchNombre=true;
					}
				}
				if(hayMatchCat==false && hayMatchNombre==true){
					arrayFaltanteCategoryLocal[arrayFaltanteCategoryLocal.length]=idCatLocal+"|"+idNube;
					var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
						db.transaction(function(tx){
						
							tx.executeSql("UPDATE PRODUCTOS SET categoriaid=? WHERE categoriaid=?;",[idNube,timeSpan],function(tx,results){
								
							});
							console.log("UPDATE PRODUCTOS SET categoriaid=? WHERE categoriaid=?" + idNube + " <> " + timeSpan);
						},errorCB ,successCB);	
					console.log("actualizar timespan abajo>>" + catLocal.categoria +  ">>" + idNube);
				}
			}

			actualizarCategoriasID();
			
			
			
		}
		
		var arrayCategoriasFaltantesNube = new Array();
		function validarJsonCategoriasNube(){
			
			JSONCategoriasNube= $("#JSONCategoriasNube").text();
			JSONCategoriasLocal=  $("#JSONCategoriasLocal").text();
			JCNube=jQuery.parseJSON(JSONCategoriasNube);
			JCLocal=jQuery.parseJSON(JSONCategoriasLocal);
			var hayMatchCat=false;
			for(i=0;i<=(JCNube.Categorias.length-1);i++){
				catNube=JCNube.Categorias[i];
				idCatNube=catNube.categoria_id;
				nombreCat=catNube.categoria_nombre;
				for(j=0; j<=JCLocal.Categorias.length-1; j++){
					
					catLocal=JCLocal.Categorias[j];
					timespanLocal=catLocal.timespan;
					if(timespanLocal==idCatNube){
						hayMatchCat=true;
					}
				}
				if(hayMatchCat==false){
					arrayCategoriasFaltantesNube[arrayCategoriasFaltantesNube.length] = nombreCat + "|" + idCatNube;
					//alert("falta de nube" + nombreCat );
				}
			}
			agregarCategoriasFalatantesNube();
			
			
			
		}
		globalContCatFaltantesNube=-1;
		function sincronizarFacturas(){
			//alert("Here is my time");
			$('#theProgress').width("50%");
			$("#txtSincro").html('<i>Sincronizando Facturas</i>');
			sincronizarClientes();
		}
		
		
		
		/*Sincronizacion Clientes STEP 3*/
		function sincronizarClientes(){
			$('#theProgress').width("75%");
			$("#txtSincro").html('<i>Sincronizando Clientes</i>');
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
					tx.executeSql('SELECT * FROM CLIENTES',[],function(tx,results){
					jsonClientesLocal='{ "JsonClientes" : [ ';
						for (var i=0; i <= results.rows.length-1; i++){
								var row = results.rows.item(i);
								var nombre = row.nombre;
								var cedula = row.cedula;
								var email = row.email;
								var telefono = row.telefono;
								var timespan = row.timespan;
								var direccion = row.direccion;
								jsonClientesLocal+=' { "timespan" : "'+timespan+'" , "nombre" : "'+nombre+'" , "cedula" : "'+cedula+'" , "email" : "'+email+'" , "telefono" : "'+telefono+'", "direccion" : "'+direccion+'"  },';
								}
								jsonClientesLocal= jsonClientesLocal.substring(0,jsonClientesLocal.length-1);
								jsonClientesLocal +=']}';
								$("#JSONclientesLocal").html(jsonClientesLocal);
								compararJsonLocalClientes(jsonClientesLocal);
								//$("#JSONclientesLocal").html();
					});
				},errorCB,successCB);
									
									
			
			
		}
		
		
		var arrayFaltanteClienteLocal= new Array();
		function compararJsonLocalClientes(json){
		 objLocal=$.parseJSON(json);
		 jsonNube=$("#JSONclientesNube").text();
		 objNube=$.parseJSON(jsonNube);
		 
		 for(j=0; j<= (objLocal.JsonClientes.length-1); j++){
			element=objLocal.JsonClientes[j];
			currentClientLocal=element.timespan;
			currentClientLocal.cedula
			if(currentClientLocal.cedula == '9999999999999'){
				alert(currentClientLocal.cedula);
				currentClientLocal=-1	;
			} 

			var matchClient=false;
			var  matchClientCedula=false;
			for( k=0;k<=(objNube.Clientes.length -1); k++){
				currentClientNube = objNube.Clientes[k].timespan;

				if(currentClientLocal == currentClientNube){
					//alert( currentClientNube + "<>" + currentClientNube);
					matchClient=true;
				}
			}
			//alert(matchClient);
			if(matchClient==false){
				
				arrayFaltanteClienteLocal[arrayFaltanteClienteLocal.length] = currentClientLocal;
				console.log(arrayFaltanteClienteLocal);
				alert("falta el cliente>>" + element.nombre);
			}
		 }
		 
		 agregarClientesFaltanteLocal();
		}
		var contFaltanteClienteLocal=-1;
		function agregarClientesFaltanteLocal(){
			contFaltanteClienteLocal++;
			if(contFaltanteClienteLocal > (arrayFaltanteClienteLocal.length-1) ){
			compararJsonNubeClientes();
			//alert("Fin de clientes");
			contFaltanteClienteLocal=-1;
			return;
			}
			if(arrayFaltanteClienteLocal.length!=-1){
				/*Json Detect Element of array*/
				var nombre='';var email=''; var telefono='';var cedula='';
				var currentClientPost=arrayFaltanteClienteLocal[contFaltanteClienteLocal];
				 objLocal=$.parseJSON($("#JSONclientesLocal").text());
				for(j=0; j<= (objLocal.JsonClientes.length-1); j++){
					element=objLocal.JsonClientes[j];
					currentClientLocal=element.timespan;
					if(currentClientLocal == currentClientPost ){
						nombre = element.nombre;
						email = element.email;
						cedula = element.cedula;
						telefono = element.telefono;
						direccion = element.direccion;
						
					}
				}
				
				
				
				alert(currentClientPost + "<>falta ese man " +  nombre );
				$.post('https://www.practisis.net/nubeposboot/www/ajax/addNewClient.php', { 
					dbID : empresa ,
					nombre : nombre,
					timespan : currentClientLocal,
					email : email,
					telefono : telefono,
					cedula : cedula,
					direccion : direccion
					}).done(function(data){
					alert(data);
					agregarClientesFaltanteLocal();
				});
			}
			
		}
		var arrayClientesFaltanteNube=new Array();
		function compararJsonNubeClientes(){
			 objLocal=$.parseJSON($("#JSONclientesLocal").text());
			 objNube=$.parseJSON($("#JSONclientesNube").text());
			 for(i=0; i<= (objNube.Clientes.length-1); i++ ) {
				match=false;
				//matchCedula=false;
				currentClientNube=  objNube.Clientes[i].timespan;
				currentClientNubeCedula=  objNube.Clientes[i].cedula;
				for(j=0; j<= (objLocal.JsonClientes.length-1); j++ ) {
					currentClientLocal=objLocal.JsonClientes[j].timespan;
					currentClientLocalCedula=objLocal.JsonClientes[j].cedula;
					if( currentClientNube == currentClientLocal ) {match=true; }
				//	if( currentClientLocalCedula == currentClientNubeCedula){matchCedula=true;}
					
				}
				
				if(!match){
				
					arrayClientesFaltanteNube[arrayClientesFaltanteNube.length]=i;
					console.log( currentClientNube + ">Falta Cliente nube" );
				}
				
			 }
			 agregarClientesFaltanteNube();
		}
		
		var contFaltanteClienteNube=-1;
		var rebelTimeSpan=0;
		function agregarClientesFaltanteNube(){
			contFaltanteClienteNube++;
			if(contFaltanteClienteNube > (arrayClientesFaltanteNube.length-1) ){

				//alert("Fin clientes");
				$("#theProgress").width("100%");
				sincronizaPresupuesto();
				//envia("cloud");
				return;
			}


			
			
			
			
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
				currentIndex= arrayClientesFaltanteNube[contFaltanteClienteNube] ;
				objNube=$.parseJSON($("#JSONclientesNube").text());
				for(i=0; i<= (objNube.Clientes.length-1); i++ ) {
					match=false;
					currentClientNube=  objNube.Clientes[i].timespan;
					if(i==currentIndex){
					//alert(objNube.Clientes[i].nombre);
					nombre = objNube.Clientes[i].nombre;
					cedula = objNube.Clientes[i].cedula;
					telefono = objNube.Clientes[i].telefono;
					direccion = objNube.Clientes[i].direccion;
					email = objNube.Clientes[i].email;
					if(currentClientNube != '') {
						timespan = currentClientNube; 
						console.log("con timespan>>" + nombre + "<<" + timespan);
						rebelTimeSpan=timespan;
						}else{
						 timespan = getTimeSpan();
						 rebelTimeSpan = timespan;
						 console.log("Sin timespan>>" + nombre + "<<" + timespan );
					}
					idCliente= objNube.Clientes[i].id;
					}
				}
					//alert(rebelTimeSpan);
					//alert(rebelTimeSpan);
				
								tx.executeSql('INSERT INTO CLIENTES (nombre,cedula,telefono,direccion,email,timespan,existe) VALUES(?,?,?,?,?,?,?) ',[nombre,cedula,telefono,direccion,email,rebelTimeSpan,0],function(tx,results){
								
												$.post('https://www.practisis.net/nubeposboot/www/ajax/updateClient.php', { 
													dbID : empresa ,
													nombre : nombre,
													timespan : rebelTimeSpan,
													idCliente : idCliente
													}).done(function(data){
													//	alert(data);
														agregarClientesFaltanteNube();
													});
												
												
										});
									},errorCB,successCB);
									
			
			
		}
		
		/*Fin Sincronizacion Clientes STEP 3*/
		
		/*SINCRONIZAR TABLA PRESUPUESTOS*/

		function sincronizaPresupuesto(){
			
				$.post('http://practisis.net/practipos2/ajax/apiSincronizador/apiSincronizaNubeposPresupuesto.php',{
							 empresa : empresa
						}).done(function(data){
							console.log(data);
							
							json=$.parseJSON(data);
							if(json.Presupuesto[0].error){
								console.log("no presupuesto");
							}
							var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
							db.transaction(function(tx){
							tx.executeSql("DELETE FROM PRESUPUESTO",[],function(tx,results){
																				
										});
							},errorCB,successCB);		
							for(i=0;i<=json.Presupuesto.length-1;i++){
								id=json.Presupuesto[i].id ;
								valor=json.Presupuesto[i].valor ;
								transacciones=json.Presupuesto[i].transacciones ;
								fecha=json.Presupuesto[i].fecha ;
								idlocal=json.Presupuesto[i].idlocal ;
					db.transaction(function(tx){
										tx.executeSql('INSERT INTO PRESUPUESTO(timespan,valor,fecha,transacciones) VALUES("'+id+'",'+valor+','+fecha+','+transacciones+')',[],function(tx,results){
										
										});
									},errorCB,successCB);

							}
							
							envia("cloud");
						});

			//envia("cloud");	
		}
			
		
		function agregarCategoriasFalatantesNube(){
			globalContCatFaltantesNube++;
			if(globalContCatFaltantesNube > (arrayCategoriasFaltantesNube.length-1) ){
			
			/*Go to section 2*/
			//alert("end of bucle");
			sincronizarFacturas();
			}else{
				
				txt= arrayCategoriasFaltantesNube[globalContCatFaltantesNube] ;
				exp=txt.split("|");
				categoria=exp[0];
				//alert(categoria);
				idReal=exp[1];
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
										tx.executeSql('INSERT INTO CATEGORIAS(categoria,existe,activo,timespan) VALUES("'+categoria+'",1,1,'+idReal+')',[],function(tx,results){
										console.log("prod:"+results.insertId);
											agregarCategoriasFalatantesNube(); //sincronizaProductoNube();
											//  alert("InsertadoProdoucto>>" + formulado );
										});
									},errorCB,successCB);
									
				
			}
		
		}
		
		
		var globalCategoriasUpdate=-1;
		var currentIDCatLocal=-1;
		var currentIDCatNube=-1;
		function actualizarCategoriasID(){
			globalCategoriasUpdate++;
			if(globalCategoriasUpdate > (arrayFaltanteCategoryLocal.length-1) ){
				//alert("fin del bucle" + arrayFaltanteCategoryLocal.length );
				/*Sincronizar de nube a local*/
				validarJsonCategoriasNube();
				
				
			}else{
				currentUpdate=arrayFaltanteCategoryLocal[globalCategoriasUpdate];
				//alert("custom: " + currentUpdate + ">>" + arrayFaltanteCategoryLocal.length);
				exp=currentUpdate.split("|");
				currentIDCatLocal=exp[0];
				currentIDCatNube=exp[1];
				//alert("Cambiar timespan Abajo" + idLocal + " por id Arriba " + idNube);
				
				
					var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
						db.transaction(function(tx){
						tx.executeSql("UPDATE CATEGORIAS SET timespan=? WHERE id=?;",[currentIDCatNube,currentIDCatLocal],function(tx,results){
							/*tx.executeSql("UPDATE PRODUCTOS SET categoriaid=? WHERE categoriaid=?;",[currentIDCatLocal,currentIDCatNube],function(tx,results){
								
							});*/
							actualizarCategoriasID();
							
						});
						

						},errorCB ,successCB);
						
			}
				
		
		}
		
		///x.executeSql("UPDATE FACTURAS SET paymentsUsed=?,cash=?,cards=?,cheques=?,vauleCxC=? WHERE id=?;",[cadenapago,efectivo,tarjetas,cheques,cc,miid],function(tx,results){
		
		function obtenerDatosNube(empresa){
			
			$.post('https://www.practisis.net/nubeposboot/www/ajax/dataserviceNew.php',{
								id_emp : empresa 
						}).done(function(response){
					//alert(response);

					var arraydatos=JSON.parse(response); 
					JSONproductosNube=arraydatos.productos;
					JSONcategoriasNube=arraydatos.categorias;
					JSONclientesNube=arraydatos.clientes;
					//alert(JSONclientesNube);
					$("#JSONclientesNube").html(JSONclientesNube);
					console.log(arraydatos);
					$("#JSONCategoriasNube").html(JSONcategoriasNube);
					$("#JSONproductosNube").html(JSONproductosNube);
					$("#JSONproductosLocal").html('');
					JSONproductosLocal='{ "Productos" : [';
					$("#JSONproductosLocal").append(JSONproductosLocal);
					var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
					db.transaction(function(tx){
					tx.executeSql('SELECT p.*,c.categoria as nombrec , p.timespan as timespan ,  c.id as idcat FROM PRODUCTOS p,CATEGORIAS c WHERE p.categoriaid=c.timespan ORDER BY p.formulado ASC',[],function(tx,results){
					
								for (var i=0; i <= results.rows.length-1; i++){
								var row = results.rows.item(i);
								var formulado = row.formulado;
								var codigo = row.codigo;
								var precio = row.precio;
								var categoriaid = row.idcat;
								var categorianombre = row.nombrec;
								var timespan = row.timespan;
								var cargaiva = row.cargaiva;
								var productofinal = row.productofinal;
								var materiaprima = row.materiaprima;
								JSONproductosLocal='{ "formulado" : "'+formulado+'"  , "codigo" : "'+codigo+'" , "precio" : "'+precio+'" , "categoriaid" : "'+categoriaid+'" , "categorianombre" : "'+categorianombre+'" , "cargaiva" : "'+cargaiva+'" , "productofinal" : "'+productofinal+'" , "materiaprima" : "'+materiaprima+'" , "timespan" : "'+timespan+'"},';
							if(i==results.rows.length-1) JSONproductosLocal=JSONproductosLocal.substring(0,JSONproductosLocal.length-1);
								$("#JSONproductosLocal").append(JSONproductosLocal);
								}
								$("#JSONproductosLocal").append(']}');
								compararJSONproductos();
						});
					},errorCB ,successCB);
						
						});
			
		}

		
		var empresa = localStorage.getItem('empresa');
		function sincronizarProcess(){
			
			empresa = localStorage.getItem('empresa');
			obtenerDatosNube(empresa);
			muestraJSONLOCALCategorias();
			
			
							
		}
		
		
		
		function muestraJSONLOCALCategorias (){

		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				db.transaction(function(tx){
			tx.executeSql('SELECT * FROM CATEGORIAS',[],function(tx,results){
					$("#JSONCategoriasLocal").html(' { "Categorias" :  [ ');
					txt='';
								for (var i=0; i <= results.rows.length-1; i++){
									var row = results.rows.item(i);
									var idCat = row.id;
									var timeSpan = row.timespan;
									var categoria = row.categoria;
									var activo = row.activo;
									var existe = row.existe;
									txt+='{  "id" : "'+idCat+'" ,  "categoria" : "'+categoria+'" ,  "activo" : "'+activo+'" ,  "existe" : "'+existe+'" ,  "timespan" : "'+timeSpan+'"  },';
									//$("#JSONCategoriasLocal").append(txt);
								}
								txt=txt.substring(0,txt.length-1);
								$("#JSONCategoriasLocal").append(txt+" ]}");
								validarJsonCategorias();
			},errorCB ,successCB);
		});
		
		}
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		/* ------------ OLD FUNCTIONS ---------- */
		function verificarEmpresas(){
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			db.transaction(function(tx){
				tx.executeSql('SELECT COUNT(id) as cuantos FROM empresa',[],function(tx,res){
					var existen=res.rows.item(0).cuantos;
					console.log(existen);
					if(existen>0){
						$('#mainDivSinc').fadeIn('slow');
						$('#cuentasSinc').css('display','none');
						
					}
				});
			
			},errorCB,successCB);
		}
		
		var page=0;
		ListarCategorias();
		getSearch();

		function ListarProductos(){
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			db.transaction(function(tx){
			tx.executeSql('SELECT p.*,c.categoria as nombrec FROM PRODUCTOS p,CATEGORIAS c WHERE p.categoriaid=c.id ORDER BY p.formulado ASC LIMIT 0,15;',[],function(tx,results){
				//console.log(results.rows.length);
				var inhtml='';
				for (var i=0; i < results.rows.length; i++){
					   var row = results.rows.item(i);
					   var checkiva='';
					   var checkprfinal='';
					   var checkmatprima='';
					   if(row.cargaiva==1)
							checkiva='checked';
					   if(row.productofinal==1)
							checkprfinal='checked';
					   if(row.materiaprima==1)
							checkmatprima='checked';
						var catname='';
					   inhtml+='<tr><td>'+row.formulado+'</td><td>'+row.codigo+'</td><td>'+row.nombrec+'</td><td style="text-align:right">'+parseFloat(row.precio).toFixed(2)+'</td><td style="text-align:center"><input disabled type="checkbox" '+checkiva+'/></td><td><span class="fa fa-edit"></span></td></tr>';
					   /*<td style="text-align:center"><input disabled type="checkbox" '+checkprfinal+'/></td><td style="text-align:center"><input disabled type="checkbox" '+checkmatprima+'/></td><td><span class="fa fa-edit"></span></td></tr>';*/
				}
				LlenarTablaProd(inhtml);
				});
			},errorCB,successCB);
		}

		function LlenarTablaProd(datos){
			$('#detailDiv2').html("<table align='center' class='table'><tr><th>Nombre</th><th>Código</th><th>Categoría</th><th style='text-align:right;'>Precio</th><th style='text-align:center'>Aplica IVA</th><th><span class='fa fa-cog'></span></th>"+datos+"</table>");
		}

		function ListarCategorias(){
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			db.transaction(function(tx){
			tx.executeSql('SELECT * FROM CATEGORIAS ORDER BY id asc;',[],function(tx,results){
				//console.log(results.rows.length);
				var inhtml='';
				for (var i=0; i < results.rows.length; i++){
					var row=results.rows.item(i);
					inhtml+='<option value="'+row.id+'">'+row.categoria+'</option>';
				}
				LlenarComboCat(inhtml);
			});
			},errorCB,successCB);
		}

		function LlenarComboCat(options){
			$('#listacategorias').append(options);
		}
		function getSearch(){
			var filtro=$('#searchKeyword').val();
			var categoria=$('#listacategorias').val();
			var desde=15*page;
			var queryextra=' p.id is not NULL';
			if(filtro!='')
				queryextra+=' and (p.formulado like "%'+filtro+'%" or p.codigo like "%'+filtro+'%")';
			if(categoria!=0)
				queryextra+=' and p.categoriaid='+categoria;

			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			db.transaction(function(tx){
				tx.executeSql('SELECT p.*,c.categoria as nombrec FROM PRODUCTOS p,CATEGORIAS c WHERE '+queryextra+' and p.categoriaid=c.id ORDER BY p.formulado asc',[],function(tx,result){
					$('#paginacion').html('');
					var npags=Math.ceil(result.rows.length/15);
					$('#totalpags').val(npags);
					$('#paginacion').append("<li onclick='CambiarPagina(-1);'><span class='enabled' id='atras'>&laquo;</span></li>");
					for(var j=0;j<npags;j++){
						var act='';
						if(page==j)
							act='active';
						$('#paginacion').append("<li class='"+act+"' onclick='CambiarPagina("+parseInt(j)+");'><span class='enabled'>"+parseInt(j+1)+"</span></li>");
					}
					$('#paginacion').append("<li onclick='CambiarPagina(-2);'><span class='enabled' id='adelante'>&raquo;</span></li>");
				});
			},errorCB,successCB);
			
			
			db.transaction(function(tx){
			tx.executeSql('SELECT p.*,c.categoria as nombrec FROM PRODUCTOS p,CATEGORIAS c WHERE '+queryextra+' and p.categoriaid=c.id ORDER BY p.formulado desc LIMIT '+desde+',15;',[],function(tx,results){
				//console.log(results);
				var inhtml='';
				for (var i=0; i < results.rows.length; i++){
					var row = results.rows.item(i);
					var checkiva='';
					var checkprfinal='';
					var checkmatprima='';
					if(row.cargaiva==1)
							checkiva='checked';
					if(row.productofinal==1)
							checkprfinal='checked';
					if(row.materiaprima==1)
							checkmatprima='checked';
					var catname='';
					inhtml+='<tr><td>'+row.formulado+'</td><td>'+row.codigo+'</td><td>'+row.nombrec+'</td><td style="text-align:right">'+parseFloat(row.precio).toFixed(2)+'</td><td style="text-align:center"><input disabled type="checkbox" '+checkiva+'/></td><td><span class="fa fa-edit" style="cursor:pointer;" onclick="EditarProducto('+row.id_local+');"></span></td></tr>';
					/*<td style="text-align:center"><input disabled type="checkbox" '+checkprfinal+'/></td><td style="text-align:center"><input disabled type="checkbox" '+checkmatprima+'/></td><td><span class="fa fa-edit" style="cursor:pointer;" onclick="EditarProducto('+row.id+');"></span></td></tr>';*/
				}
				LlenarTablaProd(inhtml);
			});
			},errorCB,successCB);
		}

		function CambiarPagina(arg){
			//console.log($('#totalpags').val());
			if(arg==-1){
				if((page-1)>=0){
					page--;
					getSearch();
				}
			}else if(arg==-2){
				//console.log($('#totalpags').val());
				if((page+1)<parseInt($('#totalpags').val())){
					page++;
					getSearch();
				}
			}else{
				page=arg;
				getSearch();
			}
			
		}

		function EditarProducto(idpr){
			$('#content').load("views/productos/nuevoproducto.html",function(){
				VerDatosProducto(idpr);
			});
		}

		$(document).keyup(function(event){
			if(event.keyCode === 13){
				getSearch();
				}
		});

			function subeDatos(){
				$('#myModal').modal('show');
				var db2 = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var miqueryFac='SELECT p.*,c.categoria as nombrec , c.id as idcat FROM PRODUCTOS p,CATEGORIAS c WHERE p.categoriaid=c.id ORDER BY p.formulado ASC';
				//alert(miqueryFac);
				var empresa = localStorage.getItem('empresa');
				console.log(empresa)
				db2.transaction(function(tx){
				tx.executeSql(miqueryFac,[],function(tx,results){
					//alert(results);
					var inhtml='';
					for (var i=0; i < results.rows.length; i++){
						var row = results.rows.item(i);
						var formulado = row.formulado;
						var codigo = row.codigo;
						var precio = row.precio;
						var categoriaid = row.idcat;
						var categorianombre = row.nombrec;
						var cargaiva = row.cargaiva;
						var productofinal = row.productofinal;
						var materiaprima = row.materiaprima;
						//alert(formulado +'@'+ categoriaid +'@'+ empresa);
						$.post('http://practisis.net/practipos2/ajax/apiSincronizador/apiSincronizaNubeposProductos.php',{
							empresa : empresa , formulado : formulado , codigo : codigo , precio : precio , categorianombre : categorianombre , cargaiva : cargaiva , productofinal : productofinal , materiaprima : materiaprima
						}).done(function(data){
							console.log(data);
						});
						
					}
					
				});
				},errorCB,successCB);
				
				setTimeout(function() {
				console.log('bajara');
					subeClientes();
					console.log('facturas')
					subeFacturas();
				}, 3000);
				
			}
			
			
			
			function subeClientes(){
				var db2 = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var miqueryFac='select * from CLIENTES order by id ASC';
				//alert(miqueryFac);
				var empresa = localStorage.getItem('empresa');
				//console.log(empresa)
				db2.transaction(function(tx){
				tx.executeSql(miqueryFac,[],function(tx,results){
					//alert(results);
					var inhtml='';
					for (var i=0; i < results.rows.length; i++){
						var row = results.rows.item(i);
						var id = row.id;
						var nombre = row.nombre;
						var cedula = row.cedula;
						var email = row.email;
						var direccion = row.direccion;
						var telefono = row.telefono;
						//alert(formulado +'@'+ categoriaid +'@'+ empresa);
						$.post('http://practisis.net/practipos2/ajax/apiSincronizador/apiSincronizaNubeposClientes.php',{
							id : id , nombre : nombre , cedula : cedula , email : email , direccion : direccion , telefono : telefono , empresa : empresa
						}).done(function(data){
							console.log(data);
						});
						
					}
					
				});
				},errorCB,successCB);
				
				setTimeout(function() {
					console.log('facturas')
					subeFacturas();
				}, 3000);
			}
			
			
			function subeFacturas(){
				var db2 = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var empresa = localStorage.getItem('empresa');
				var miqueryFac='SELECT * from FACTURAS where aux = ? order by id ASC';
				db2.transaction(function(tx){
				tx.executeSql(miqueryFac,[0],function(tx,resultsfact){
					//alert(results);
					//var existenD=resultsfact.rows.item(0).cuantos;
					//if(existenD>0){
						var inhtml='';
						for (var i=0; i < resultsfact.rows.length; i++){
								var rowfact = resultsfact.rows.item(i);
								var id = rowfact.id;
								console.log(id);
								enviaFacturas(id);
							}
					//}
				});
				},errorCB,successCB);
			}
			function enviaFacturas(id){
				console.log(id);
				var db2 = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var empresa = localStorage.getItem('empresa');
				var miqueryFac='SELECT * from FACTURAS where aux = ? and id = ? order by id ASC';
				db2.transaction(function(tx){
				tx.executeSql(miqueryFac,[0 , id ],function(tx,resultsfact){
					//alert(results);
					var inhtml='';
					for (var i=0; i < resultsfact.rows.length; i++){
							var rowfact = resultsfact.rows.item(i);
							var id = rowfact.id;
							var clientName = rowfact.clientName;
							var ruc = rowfact.RUC;
							var address = rowfact.address;
							var tele = rowfact.tele;
							var fetchJson = rowfact.fetchJson; 
							var paymentsUsed = rowfact.paymentsUsed;
							var cash = rowfact.cash;
							var cards = rowfact.cards;
							var cheques = rowfact.cheques;
							var valueCxC = rowfact.valueCxC;
							var paymentConsumoInterno = rowfact.paymentConsumoInterno;
							var fecha = rowfact.fecha;
							//alert(fetchJson);
							$.post('http://practisis.net/sandbox/practipos2/ajax/apiSincronizador/apiSincronizaNubepos.php',{
								fetchJson : fetchJson , empresa : empresa , id : id , fecha : fecha
							}).done(function(data){
								console.log(data);
								var datos = data.split("@");
								var id = datos[0];
								console.log(id);
								var idreal = datos[1];
								console.log(idreal);
								var db2 = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
								db2.transaction(function(tx){
								tx.executeSql('update FACTURAS set aux = ? where id = ?',[idreal , id],function(tx,results){
									console.log(results);
								});
								},errorCB,successCB);
								setTimeout(function() {
									console.log('bajadaaaaa');
									enviaConsultaApi2(empresa); 
								}, 3000);
							});
						}
						
						//console.log(fetchJson);
						
						
					
				});
				},errorCB,successCB);
			}
			function enviaConsultaApi2(id){
				var id_emp = id
				$.post('https://www.practisis.net/nubeposboot/www/ajax/dataservice.php',{
					id_emp : id_emp 
				}).done(function(response){
					console.log(response);
					var arraydatos=JSON.parse(response); 
					//alert(response);
					$('#empresaName').html(arraydatos.empresa.nombre);
					$('#nemp').html("Emp. "+arraydatos.empresa.num);
					$('#jsonProductos').html(arraydatos.productos);
					$('#jsonCategorias').html(arraydatos.categorias);
					$('#jsonformaspago').html(arraydatos.formaspago);
					$('#jsonmisclientes').html(arraydatos.clientes);
					$('#jsoncaja').html(arraydatos.cajas);
					$('#loginPractisis').fadeOut('fast');
					Ingresaproductos2();
					IngresaCategorias2();
					IngresaClientes2();
					//console.log(arraydatos);
				});
			}
			
			function Ingresaproductos2(){
				 var json = $('#jsonProductos').html();
					var mijson = eval(''+json+'');
					for(var j in mijson){
						for(var k in mijson[j]){
							for(i = 0; i < mijson[j][k].length; i++){
									var item = mijson[j][k][i];
									InsertaProducto2(item);
							}
						}
					}
			}
			
			function InsertaProducto2(itempr){
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var cargaiva=0;
				var imp=itempr.formulado_tax_id.split('|');
				
				if(imp.indexOf("1")>=0)
					cargaiva=1;
				var nombreFormulado = itempr.formulado_nombre;
				//console.log(nombreFormulado);
				
				var miqueryProd="SELECT * FROM PRODUCTOS  where lower(formulado) =  lower('"+nombreFormulado+"') ORDER BY id asc";
				//console.log(miqueryProd);
				db.transaction(function(tx){
				tx.executeSql(miqueryProd,[],function(tx,results){
					console.log(results.rows.length +'@'+ nombreFormulado);
					if(results.rows.length > 0 ){
						console.log('no ingresara este producto:     ' + nombreFormulado);
					}else{
						db.transaction(
						function (tx){
								tx.executeSql('INSERT INTO PRODUCTOS (id,formulado,codigo,precio,categoriaid,cargaiva,productofinal,materiaprima) VALUES (?,?,?,?,?,?,?,?);',[itempr.formulado_id,itempr.formulado_nombre,itempr.formulado_codigo,itempr.formulado_precio,itempr.formulado_tipo,cargaiva,1,itempr.formulado_matprima],
								function(tx,res){
									console.log("producto insertado:"+res.insertId)
								});				
						},errorCB,successCB);
					}
					
				});
				},errorCB,successCB);
				
					
			}
			
			function IngresaCategorias2(){
				var json = $('#jsonCategorias').html();
					var mijson = JSON.parse(json);
					//alert(mijson);
					for(var j in mijson){
						for(var k in mijson[j]){
								var item=mijson[j][k];
								metedatoscat2(item);
						}
					}
			}
				
			function metedatoscat2(itemc){
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
				var categoria_nombre = itemc.categoria_nombre; 
				
				var miqueryCat="SELECT * FROM CATEGORIAS  where lower(categoria) =  lower('"+categoria_nombre+"') ORDER BY id asc";
				
				
				db.transaction(function(tx){
				tx.executeSql(miqueryCat,[],function(tx,results){
					console.log(results.rows.length +'@'+ categoria_nombre);
					if(results.rows.length > 0 ){
						console.log('no ingresara esta categoria:     ' + categoria_nombre);
					}else{
						db.transaction(
						function (tx){
							tx.executeSql('INSERT INTO CATEGORIAS(id,categoria,activo,existe)VALUES(?,?,?,?);',[itemc.categoria_id,itemc.categoria_nombre,1,1],
							function(tx,res){
								console.log(res);
								console.log("Categoria ingresada :"+res.insertId+"  categorias");
							});				
						},errorCB,successCB);
					}
					
				});
				},errorCB,successCB);
				
			}
				
			function IngresaClientes2(){
				var json = $('#jsonmisclientes').html();
					var mijson = JSON.parse(json);
					//console.log(mijson);
					for(var j in mijson){
						for(var k in mijson[j]){
								var item=mijson[j][k];
								metedatoscliente2(item);
						}
					}
			}
				
			function metedatoscliente2(itemc){
				var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			
				var cedula = itemc.cedula; 
				
				var miqueryCli="SELECT * FROM CLIENTES  where lower(cedula) =  lower('"+cedula+"') ORDER BY id asc";
				
				
				db.transaction(function(tx){
				tx.executeSql(miqueryCli,[],function(tx,results){
					console.log(results.rows.length +'@'+ cedula);
					if(results.rows.length > 0 ){
						console.log('no ingresara este cliente:     ' + cedula);
					}else{
						
						db.transaction(
							function (tx){
										tx.executeSql('INSERT INTO CLIENTES(id,nombre,cedula,telefono,direccion,email,existe)VALUES(?,?,?,?,?,?,?);',[itemc.id,itemc.nombre,itemc.cedula,itemc.telefono,itemc.direccion,itemc.email,1],
										function(tx,res){
											//console.log(res);
											console.log("Cliente:  "+res.insertId+"clientes");
										});				
							},errorCB,successCB);
					}
					
				});
				},errorCB,successCB);
				$('#myModal').modal('hide');
			}
			//$("#fadeRow").fadeIn("slow");
			function registrarUser(){
				newEmpresa=$("#newEmpresa").val();
				newEmail=$("#newEmail").val();
				newPass=$("#newPass").val();
				newConfirm=$("#newConfirm").val();
				if(newConfirm == newPass){
					nombre='User NubePOS';
					celular=0;
					email=0;
					passw=newPass;
					rpassw=newConfirm;
					empresa=newEmpresa;
					planPrecio=2;
					nTerminales=1;
					sistema=0;
					franquicia=0;
					pais=1;
					versiones=7;
					plan=0;
					$("#btnNewEmp").html('<img src="images/loader.gif"  width="50%" />');
					$.post("http://practisis.net/registro/registroNubePOS.php", { 
						nombre : nombre,
						celular : celular,
						email :newEmail,
						pass : newPass,
						rpass : newConfirm,
						empresa : empresa,
						planPrecio : planPrecio,
						nTerminales : nTerminales,
						sistema : sistema,
						pais : pais,
						franquicia : franquicia,
						versiones : versiones

					}).done(function(data){
						$("#btnNewEmp").html('Enviar');
						$("#demoGratis").css("display" , "none");
						$("#fadeRow").css("display" , "none");
						$("#putHereIframes").html(data);
						$("#putHereIframes").prepend("Procesando Petición");
						$("#fadeCloud").html("\
								<table width='100%' height='100%' cellpadding='0'  cellspacing='0'>\
									<tr>\
										<td valign='center' align='center' > \
									<iframe src='views/cloud/timer.html' style='width:60%;height:50%;border:0px;' border='0' ></iframe>\
										</td>\
									</tr>\
								</table>\
									");
						$("#fadeCloud").fadeIn();
						//alert(data);
					});

				}
				//alert( newEmpresa + "<>" + newEmail + "<>" + newPass + "<>" + newConfirm );

			}
			$(".putHeightRows").css("height" , $(window).height() + "px");
				
	</script>
